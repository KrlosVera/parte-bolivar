<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Parte de Compañía - Simón Bolívar</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: #f0f4ff;
            margin: 0;
            padding: 10px;
            color: #222;
        }
        h1 {
            text-align: center;
            color: #003399;
            font-size: 1.3em;
            margin-bottom: 10px;
        }
        .seccion, .footer, #login-overlay, #master-key-modal, #config-pin-modal {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            padding: 10px;
            margin-bottom: 10px;
        }
        .fila {
            display: flex;
            justify-content: space-between;
            gap: 6px;
            align-items: center;
            margin-top: 6px;
        }
        .seccion h3 {
            margin: 0;
            font-size: 1em;
            color: #003399;
            text-align: center;
        }
        label {
            display: block;
            font-size: 0.78em;
            font-weight: 600;
            margin-bottom: 4px;
            text-align: center;
        }
        .campo-grupo {
            flex: 1 1 42%;
        }
        .campo-grupo.nov {
            flex: 1 1 14%;
        }
        input {
            padding: 8px;
            font-size: 15px;
            border: 1px solid #c1c7d0;
            border-radius: 6px;
            text-align: center;
            box-sizing: border-box;
            width: 100%;
            transition: border-color 0.3s, background-color 0.3s;
        }
        input[readonly] {
            background: #f3f3f3;
            color: #333;
        }
        input.invalido {
            background-color: #fff3f3;
            border-color: #e00;
        }
        .botones { display: flex; gap: 8px; margin-top: 8px; }
        button {
            flex: 1;
            background: #004aad;
            color: white;
            font-size: 15px;
            border: none;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
        }
        button.secondary { background: #28a745; }
        button.warning { background: #ffc107; color: #333; }
        button.logout { 
            flex: initial; /* No crecer tanto */
            background: #dc3545; /* Rojo */
            padding: 5px 10px; /* Más discreto */
            font-size: 13px;
        }
        button:hover { opacity: 0.95; }
        .resumen {
            background: #eaf3ff;
            padding: 10px;
            border-radius: 10px;
            margin-top: 12px;
            text-align: center;
            font-size: 15px;
            font-weight: 600;
            color: #003366;
        }
        .lista-novedades {
            text-align: left;
            margin-top: 8px;
            font-size: 14px;
            color: #222;
            line-height: 1.4;
        }
        .footer {
            margin-top: 20px;
            padding: 8px;
            font-size: 0.75em;
            color: #555;
            text-align: center;
            box-shadow: none;
        }

        /* --- Estilos para Overlays/Modales --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(240, 244, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.3s;
            flex-direction: column;
        }
        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            max-width: 300px;
            width: 90%;
            text-align: center;
        }
        .modal-content input {
            margin-bottom: 10px;
            font-size: 18px;
        }
        .modal-message {
            color: red;
            font-size: 0.9em;
            margin-top: 5px;
        }

        /* Ocultar modales por defecto */
        #master-key-modal, #config-pin-modal {
            display: none;
            background: rgba(0,0,0,0.5); 
        }
        #login-overlay {
            display: flex; 
        }
        
        /* Contenedor de la app con el botón de salir */
        #app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }


        @media (min-width: 600px) {
            body { width: 420px; margin: auto; }
            .modal-overlay { width: 420px; margin: 0 auto; left: 50%; transform: translateX(-50%); }
        }
    </style>
</head>
<body>

    <div id="login-overlay" class="modal-overlay">
        <div id="login-content" class="modal-content">
            <h2>Acceso a Parte de Compañía</h2>
            <p>Ingresa el PIN de acceso:</p>
            <input type="password" id="pin-input" placeholder="PIN" maxlength="4" />
            <button id="btn-login">Ingresar</button>
            <p id="login-message" class="modal-message"></p>
            <button id="btn-show-master-key" class="warning" style="margin-top: 10px; flex: initial; font-size: 15px;">Cambiar PIN de Acceso</button>
            <p style="font-size: 0.8em; color: #888; margin-top: 10px;">
                PIN actual (o por defecto): <span id="current-pin-display">Cargando...</span>
            </p>
        </div>
    </div>
    <div id="master-key-modal" class="modal-overlay">
        <div id="master-key-content" class="modal-content">
            <h3>Clave Maestra de Configuración</h3>
            <p>Ingresa la clave para modificar el PIN de acceso:</p>
            <input type="password" id="master-key-input" placeholder="Clave Maestra" maxlength="4" />
            <button id="btn-check-master-key">Verificar</button>
            <button class="secondary" id="btn-close-master-key-modal">Cancelar</button>
            <p id="master-key-message" class="modal-message"></p>
        </div>
    </div>
    <div id="config-pin-modal" class="modal-overlay">
        <div id="config-pin-content" class="modal-content">
            <h3>Establecer Nuevo PIN de Acceso</h3>
            <input type="password" id="new-pin-input" placeholder="Nuevo PIN (4 dígitos)" maxlength="4" />
            <input type="password" id="confirm-pin-input" placeholder="Confirmar Nuevo PIN" maxlength="4" />
            <button id="btn-change-pin">Guardar Nuevo PIN</button>
            <button class="secondary" id="btn-close-pin-modal">Cancelar</button>
            <p id="pin-config-message" class="modal-message"></p>
            <p id="pin-update-note" style="font-size: 0.8em; color: #dc3545; margin-top: 10px;">
                ⚠️ Recuerda actualizar el PIN en el código fuente (HTML) para que sea el valor por defecto si borras la memoria del navegador.
            </p>
        </div>
    </div>
    <div id="app-content" style="display: none;">
        
        <div id="app-header">
            <h1>Parte de Compañía "Simón Bolívar"</h1>
            <button id="btn-logout" class="logout">Salir</button>
        </div>

        <div id="secciones"></div>

        <div class="botones">
            <button id="btnCalcular">Calcular Totales</button>
            <button class="secondary" id="btnExportar">Exportar Parte a TXT</button>
        </div>

        <div class="resumen" id="resultado">
            <p>Fuerza Efectiva Total: -</p>
            <p>Fuerza Disponible Total: -</p>
            <p>Novedades Totales: -</p>
        </div>

        <div class="lista-novedades" id="detalleNovedades"></div>
    </div>

    <div class="footer">
        <p>
            Código desarrollado por: **Carlos Vera**
            <br>
            **Escuela de Gabriel Gonzalez Lopez**
            <br>
            &copy; 2025. Todos los derechos reservados.
        </p>
    </div>

    <script>
        // --- 0. LÓGICA DE LOGIN, SEGURIDAD Y TEMPORIZADOR ---

        const PIN_STORAGE_KEY = 'parte_pin_hash';
        // PIN de ACCESO inicial por defecto (si no hay uno guardado en localStorage)
        const DEFAULT_ACCESS_PIN = '1234'; 
        // CLAVE MAESTRA de CONFIGURACIÓN (fija en el código): 9876
        const MASTER_KEY = '9876'; 
        // TIEMPO DE INACTIVIDAD (en milisegundos): 30 minutos * 60 segundos * 1000 ms
        const INACTIVITY_TIMEOUT = 30 * 60 * 1000; 

        let activityTimer;

        // Hashing simple para ofuscar el PIN en localStorage
        function hash(pin) {
            return btoa(pin + 'carlos'); 
        }

        function getStoredPinHash() {
            return localStorage.getItem(PIN_STORAGE_KEY) || hash(DEFAULT_ACCESS_PIN);
        }

        // --- Manejo del Temporizador de Inactividad ---
        function resetTimer() {
            clearTimeout(activityTimer);
            activityTimer = setTimeout(logout, INACTIVITY_TIMEOUT);
        }

        function setupActivityListeners() {
            // Reinicia el temporizador con cualquier actividad en el documento
            document.addEventListener('mousemove', resetTimer);
            document.addEventListener('keypress', resetTimer);
            document.addEventListener('touchstart', resetTimer);
            document.addEventListener('scroll', resetTimer);
            // También al interactuar con los inputs
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => input.addEventListener('input', resetTimer));
        }

        function logout() {
            clearTimeout(activityTimer);
            localStorage.removeItem('parte_authenticated_hash');
            // Muestra el PIN actual para el usuario antes de desloguearse (para recordar)
            displayCurrentPin(); 
            document.getElementById('app-content').style.display = 'none';
            document.getElementById('login-overlay').style.display = 'flex';
            alert("Sesión cerrada automáticamente por inactividad (30 minutos).");
        }
        
        function checkAuthentication() {
            const storedAuthHash = localStorage.getItem('parte_authenticated_hash');
            const requiredPinHash = getStoredPinHash();
            return storedAuthHash === requiredPinHash;
        }

        function showApp() {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('app-content').style.display = 'block';
            resetTimer(); // Inicia el temporizador de inactividad
            calcularParte(); // Inicializar la app
        }
        
        // Muestra el PIN que el usuario debe usar
        function displayCurrentPin() {
            const currentHash = getStoredPinHash();
            const pinDisplay = document.getElementById('current-pin-display');
            
            // Si el PIN es el valor por defecto, lo mostramos
            if (currentHash === hash(DEFAULT_ACCESS_PIN)) {
                pinDisplay.textContent = `${DEFAULT_ACCESS_PIN} (por defecto)`;
            } else {
                // Si el PIN ha sido cambiado (y está en localStorage), no podemos mostrar el valor real
                // Mostramos un mensaje que indica que se cambió localmente.
                pinDisplay.textContent = 'Guardado en el navegador (no es el valor por defecto)';
            }
        }


        // --- Manejo del Login de Acceso (PIN de 4 dígitos) ---
        function handleLogin() {
            const pinInput = document.getElementById('pin-input');
            const messageDiv = document.getElementById('login-message');
            const pin = pinInput.value;

            messageDiv.textContent = '';

            if (pin.length !== 4) {
                messageDiv.textContent = 'El PIN de acceso debe ser de 4 dígitos.';
                return;
            }

            const enteredHash = hash(pin);
            const storedHash = getStoredPinHash();

            if (enteredHash === storedHash) {
                localStorage.setItem('parte_authenticated_hash', enteredHash);
                pinInput.value = '';
                showApp();
            } else {
                messageDiv.textContent = 'PIN de acceso incorrecto.';
                pinInput.classList.add('invalido');
                setTimeout(() => pinInput.classList.remove('invalido'), 1000);
            }
        }

        // --- Manejo de la Clave Maestra de Configuración ---
        function checkMasterKey() {
            const masterKeyInput = document.getElementById('master-key-input');
            const messageDiv = document.getElementById('master-key-message');
            const enteredKey = masterKeyInput.value;

            messageDiv.textContent = '';

            if (enteredKey === MASTER_KEY) {
                masterKeyInput.value = '';
                document.getElementById('master-key-modal').style.display = 'none';
                document.getElementById('config-pin-modal').style.display = 'flex';
            } else {
                messageDiv.textContent = 'Clave Maestra incorrecta. Acceso denegado.';
                masterKeyInput.classList.add('invalido');
                setTimeout(() => masterKeyInput.classList.remove('invalido'), 1000);
            }
        }

        // --- Manejo del Cambio de PIN de Acceso ---
        function changeAccessPin() {
            const newPinInput = document.getElementById('new-pin-input');
            const confirmPinInput = document.getElementById('confirm-pin-input');
            const messageDiv = document.getElementById('pin-config-message');

            const newPin = newPinInput.value;
            const confirmPin = confirmPinInput.value;
            messageDiv.textContent = '';

            if (newPin.length !== 4 || isNaN(newPin)) {
                messageDiv.textContent = 'El nuevo PIN debe ser un número de 4 dígitos.';
                return;
            }

            if (newPin !== confirmPin) {
                messageDiv.textContent = 'Los PINs no coinciden.';
                return;
            }

            const newPinHash = hash(newPin);
            localStorage.setItem(PIN_STORAGE_KEY, newPinHash);
            localStorage.setItem('parte_authenticated_hash', newPinHash); 
            
            messageDiv.style.color = 'green';
            messageDiv.textContent = '¡PIN de acceso cambiado y guardado exitosamente en el navegador!';
            
            // Actualizar la visualización del PIN actual en el login
            displayCurrentPin();

            setTimeout(() => {
                document.getElementById('config-pin-modal').style.display = 'none';
                messageDiv.style.color = 'red'; 
                newPinInput.value = '';
                confirmPinInput.value = '';
            }, 2500); // 2.5 segundos para que se pueda leer la nota
        }

        function setupSecurityListeners() {
            document.getElementById('btn-login').addEventListener('click', handleLogin);
            document.getElementById('pin-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });

            // Botón de Salir (Logout)
            document.getElementById('btn-logout').addEventListener('click', logout);

            // Abrir Modal de Clave Maestra
            document.getElementById('btn-show-master-key').addEventListener('click', () => {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('master-key-modal').style.display = 'flex';
                document.getElementById('master-key-message').textContent = '';
                document.getElementById('master-key-input').focus();
            });

            // Verificar Clave Maestra
            document.getElementById('btn-check-master-key').addEventListener('click', checkMasterKey);
            document.getElementById('master-key-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkMasterKey();
            });

            // Cancelar Clave Maestra
            document.getElementById('btn-close-master-key-modal').addEventListener('click', () => {
                document.getElementById('master-key-modal').style.display = 'none';
                document.getElementById('login-overlay').style.display = 'flex'; 
            });

            // Guardar Nuevo PIN
            document.getElementById('btn-change-pin').addEventListener('click', changeAccessPin);

            // Cancelar Cambio de PIN
            document.getElementById('btn-close-pin-modal').addEventListener('click', () => {
                document.getElementById('config-pin-modal').style.display = 'none';
                // Volvemos al contenido de la aplicación si el usuario está logueado
                if (checkAuthentication()) {
                    document.getElementById('app-content').style.display = 'block';
                }
            });
        }


        // Espera a que el DOM esté cargado para ejecutar el script
        document.addEventListener('DOMContentLoaded', () => {

            const contenedor = document.getElementById('secciones');
            const resultadoDiv = document.getElementById('resultado');
            const detalleNovedadesDiv = document.getElementById('detalleNovedades');
            const ordenNovedades = [];
            const NUM_SECCIONES = 5;

            // --- 1. CREACIÓN DEL DOM ---

            function crearSecciones() {
                const htmlSecciones = [];
                for (let i = 1; i <= NUM_SECCIONES; i++) {
                    htmlSecciones.push(`
                        <div class="seccion" id="sec${i}">
                            <h3>${i}ª Sección</h3>
                            <div class="fila">
                                <div class="campo-grupo">
                                    <label for="efectiva${i}">Efec.</label>
                                    <input type="number" id="efectiva${i}" min="0" max="999" />
                                </div>
                                <div class="campo-grupo">
                                    <label for="disponible${i}">Disp.</label>
                                    <input type="number" id="disponible${i}" min="0" max="999" />
                                </div>
                                <div class="campo-grupo nov">
                                    <label for="novedades${i}">Nov.</label>
                                    <input type="number" id="novedades${i}" readonly />
                                </div>
                            </div>
                        </div>
                    `);
                }
                contenedor.innerHTML = htmlSecciones.join('');
            }

            // --- 2. MANEJO DE EVENTOS ---

            function adjuntarListeners() {
                document.getElementById('btnCalcular').addEventListener('click', calcularParte);
                document.getElementById('btnExportar').addEventListener('click', exportarParte);
                
                for (let i = 1; i <= NUM_SECCIONES; i++) {
                    const inputs = [
                        document.getElementById(`efectiva${i}`),
                        document.getElementById(`disponible${i}`)
                    ];
                    inputs.forEach(input => {
                        input.addEventListener('input', () => actualizarNovedades(i));
                    });
                }
            }

            // --- 3. LÓGICA DE NEGOCIO ---

            function getDatosSeccion(i) {
                const efInput = document.getElementById(`efectiva${i}`);
                const dispInput = document.getElementById(`disponible${i}`);
                const novInput = document.getElementById(`novedades${i}`);

                let e = parseInt(efInput.value) || 0;
                let d = parseInt(dispInput.value) || 0;

                if (e < 0) e = 0;
                if (d < 0) d = 0;

                dispInput.classList.remove('invalido');

                if (d > e) {
                    d = e;
                    dispInput.classList.add('invalido');
                    setTimeout(() => {
                        dispInput.classList.remove('invalido');
                    }, 1500);
                }

                efInput.value = e;
                dispInput.value = d;
                
                const n = Math.max(0, e - d);
                novInput.value = n;

                return { e, d, n };
            }

            function actualizarNovedades(i) {
                const { n } = getDatosSeccion(i);

                const indexEnOrden = ordenNovedades.indexOf(i);
                
                // Si tiene novedades, la sección va al final de la lista de reporte
                if (n > 0) {
                    if (indexEnOrden !== -1) {
                        ordenNovedades.splice(indexEnOrden, 1);
                    }
                    ordenNovedades.push(i);
                } else {
                    // Si no tiene novedades, la quitamos del orden de reporte
                    if (indexEnOrden !== -1) {
                        ordenNovedades.splice(indexEnOrden, 1);
                    }
                }
            }

            function recolectarYCalcularTotales() {
                let totalEfectiva = 0;
                let totalDisponible = 0;
                let totalNovedades = 0;
                const datosSecciones = [];

                for (let i = 1; i <= NUM_SECCIONES; i++) {
                    const datosSeccion = getDatosSeccion(i);
                    datosSecciones.push(datosSeccion);

                    totalEfectiva += datosSeccion.e;
                    totalDisponible += datosSeccion.d;
                    totalNovedades += datosSeccion.n;
                }

                const listOrdenada = [];
                const seccionesReportadas = new Set();

                // 1. Añadir secciones que SÍ reportaron novedades (en orden de reporte)
                ordenNovedades.forEach(i => {
                    if (!seccionesReportadas.has(i)) {
                        listOrdenada.push({ seccion: i, novedades: datosSecciones[i - 1].n });
                        seccionesReportadas.add(i);
                    }
                });

                // 2. Añadir secciones restantes (las que tienen 0 novedades) en orden numérico
                for (let i = 1; i <= NUM_SECCIONES; i++) {
                    if (!seccionesReportadas.has(i)) {
                        listOrdenada.push({ seccion: i, novedades: datosSecciones[i - 1].n });
                    }
                }
                
                return {
                    totales: { totalEfectiva, totalDisponible, totalNovedades },
                    secciones: datosSecciones,
                    listOrdenada: listOrdenada
                };
            }

            // --- 4. FUNCIONES DE BOTONES (Cálculo y Exportación) ---

            function calcularParte() {
                const datos = recolectarYCalcularTotales();
                
                resultadoDiv.innerHTML = `
                    <p>Compañía Simón Bolívar</p>
                    <p>Fuerza Efectiva Total: ${datos.totales.totalEfectiva}</p>
                    <p>Fuerza Disponible Total: ${datos.totales.totalDisponible}</p>
                    <p>Novedades Totales: ${datos.totales.totalNovedades}</p>
                `;

                detalleNovedadesDiv.innerHTML = `<strong>Orden de reporte completo:</strong><br>` +
                    datos.listOrdenada
                        .map(s => {
                            const textoNov = s.novedades > 0 ? `→ ${s.novedades} nov.` : `(Sin novedad)`;
                            return `${s.seccion}ª Sección ${textoNov}`;
                        }).join('<br>');
            }

            function exportarParte() {
                const datos = recolectarYCalcularTotales();
                
                let texto = `Parte de Compañía 'Simón Bolívar' - ${new Date().toLocaleString()}\n\n`;
                
                datos.secciones.forEach((s, index) => {
                    const i = index + 1;
                    texto += `${i}ª Sección → Efectiva: ${s.e}, Disponible: ${s.d}, Novedades: ${s.n}\n`;
                });
                
                texto += `\nTotales:\n`;
                texto += `Fuerza Efectiva: ${datos.totales.totalEfectiva}\n`;
                texto += `Fuerza Disponible: ${datos.totales.totalDisponible}\n`;
                texto += `Novedades: ${datos.totales.totalNovedades}\n\n`;

                texto += `Orden de reporte:\n`;
                const listaTexto = datos.listOrdenada.map(s => {
                    const textoNov = s.novedades > 0 ? `(${s.novedades} nov.)` : `(Sin novedad)`;
                    return `${s.seccion}ª Secc. ${textoNov}`;
                });
                texto += listaTexto.join(' -> ') + '\n';

                texto += `\n--- Autoría ---\n`;
                texto += `Código desarrollado por: Carlos Vera\n`;
                texto += `Escuela de Gabriel Gonzalez Lopez\n`;


                const blob = new Blob([texto], { type: "text/plain;charset=utf-8" });
                const enlace = document.createElement("a");
                enlace.href = URL.createObjectURL(blob);
                enlace.download = `parte_compania_${new Date().toISOString().slice(0,10)}.txt`;
                enlace.click();
                URL.revokeObjectURL(enlace.href);
            }

            // --- 5. INICIALIZACIÓN ---
            
            crearSecciones();
            adjuntarListeners();
            setupSecurityListeners();
            setupActivityListeners(); // Configura el temporizador

            // Mostrar el login o la app al cargar
            displayCurrentPin();
            if (!checkAuthentication()) {
                document.getElementById('login-overlay').style.display = 'flex';
            } else {
                showApp();
            }
        });
    </script>

</body>
</html>